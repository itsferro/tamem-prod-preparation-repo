<div class="modal-content">
  <div class="modal-header">
    <h4 class="modal-title">
      <i class="fas fa-tasks me-2"></i>
      Block Development Tracking
    </h4>
    <button type="button" class="btn-close" aria-label="Close" (click)="onCancel()"></button>
  </div>

  <div class="modal-body">
    <!-- Block Information -->
    <div class="block-info-header mb-4">
      <div class="d-flex align-items-center">
        <div class="block-icon me-3">
          <i class="fas fa-cube fa-2x text-primary"></i>
        </div>
        <div>
          <h5 class="mb-1">{{ editBlock?.title }}</h5>
          <p class="text-muted mb-0">
            <i class="fas fa-clock me-1"></i>
            Duration: {{ editBlock?.duration || '0' }} minutes
            <span class="ms-3">
              <i class="fas fa-hashtag me-1"></i>
              Block ID: {{ editBlock?.id }}
            </span>
          </p>
        </div>

        <div style="width:100%;text-align: right;">
          <button class="btn btn-outline-primary me-2" (click)="generateBlockTasks(editBlock?.id)">Init Tasks</button>
          <button class="btn btn-outline-primary me-2" (click)="deleteBlockTasks(editBlock?.id)">Delete Tasks</button>
        </div>
      </div>
    </div>

    <!-- Error Message -->
    @if (errorMessage) {
    <div class="alert alert-danger" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>
      {{ errorMessage }}
    </div>
    }

    <!-- Phase Tasks List -->
    <div class="phases-container">
      <h6 class="mb-3">
        <i class="fas fa-list-check me-2"></i>
        Development Phases
      </h6>

      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th width="5%">#</th>
              <th width="25%">Phase</th>
              <th width="12%">Status</th>
              <th width="12%">Points</th>
              <th width="12%">Working Time</th>
              <th width="15%">Assigned To</th>
              <th width="15%">Last Updated</th>
            </tr>
          </thead>
          <tbody>
            @for (task of blockTasks; track task.phaseId) {
            <tr [class]="getRowStatusClass(task.status)" [class.table-warning]="task.isStuck">
              <!-- Phase Order -->
              <td class="text-center">
                <span class="badge bg-light text-dark">{{ $index + 1 }}</span>
              </td>

              <!-- Phase Info -->
              <td>
                <div class="d-flex align-items-center phase-info">
                  <i [class]="task.phaseIconClass + ' me-2 text-primary'"></i>
                  <div>
                    <div class="fw-medium phase-clickable" (click)="openTaskStatusLog(task)"
                      title="Click to view task flow">
                      {{ task.phaseShortName }}
                    </div>
                    <small class="text-muted">{{ task.phaseName }}</small>
                  </div>
                </div>
              </td>

              <!-- Status with Icon -->
              <td>
                <div class="text-center">
                  <span class="status-badge" [ngClass]="getStatusClass(task.status)">
                    <i [class]="getStatusIcon(task.status)"></i>
                    {{ getStatusLabel(task.status) }}
                  </span>
                </div>
              </td>

              <!-- Points -->
              <td>
                <div class="text-center">
                  <span class="badge bg-info">{{ task.estimatedPoints }} pts</span>
                  <div>
                    <small class="text-muted">estimated</small>
                  </div>
                </div>
              </td>

              <!-- Working Time -->
              <td>
                <div class="text-center">
                  <div class="fw-medium">{{ task.estimatedWorkingMinutes }} min</div>
                  <small class="text-muted">
                    {{ task.actualWorkingMinutes || 0 }} actual
                  </small>
                </div>
              </td>

              <!-- Assigned To -->
              <td>
                <div class="assigned-user-info">
                  @if (task.assignedToUserName && task.assignedToUserName !== 'Unassigned') {
                  <div class="d-flex align-items-center">
                    <div class="user-avatar me-2">
                      {{ getUserInitials(task.assignedToUserName) }}
                    </div>
                    <div>
                      <div class="user-name">{{ task.assignedToUserName }}</div>
                    </div>
                  </div>
                  } @else {
                  <div class="text-center">
                    <i class="fas fa-user-slash text-muted"></i>
                    <div><small class="text-muted">Unassigned</small></div>
                  </div>
                  }
                </div>
              </td>

              <!-- Last Updated -->
              <td>
                <div class="last-updated-info">
                  <div class="d-flex align-items-center">
                    <div class="update-avatar me-2">
                      {{ getUserInitials(task.lastUpdatedByUserName) }}
                    </div>
                    <div>
                      <div class="update-user">{{ task.lastUpdatedByUserName }}</div>
                      <small class="text-muted">{{ formatDate(task.lastUpdatedAt) }}</small>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mt-4 summary-cards">
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-tasks fa-2x text-primary mb-2"></i>
            <h6>Total Phases</h6>
            <h4>{{ blockTasks.length }}</h4>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
            <h6>Completed</h6>
            <h4>{{ getCompletedTasksCount() }}</h4>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-hourglass-half fa-2x text-warning mb-2"></i>
            <h6>In Progress</h6>
            <h4>{{ getInProgressTasksCount() }}</h4>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
            <h6>Stuck</h6>
            <h4>{{ getStuckTasksCount() }}</h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <div class="d-flex justify-content-between w-100">
      <div>
        <small class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          Click stuck flag if a task is blocked or needs attention
        </small>
      </div>
      <div>
        <button type="button" class="btn btn-secondary me-2" (click)="onCancel()" [disabled]="isSubmitting">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" (click)="onSave()" [disabled]="isSubmitting">
          @if (isSubmitting) {
          <span class="spinner-border spinner-border-sm me-2" role="status"></span>
          Saving...
          } @else {
          <i class="fas fa-save me-2"></i>
          Save Changes
          }
        </button>
      </div>
    </div>
  </div>
</div>