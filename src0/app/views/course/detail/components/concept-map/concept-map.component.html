<div class="concept-map-challenge" dir="rtl" lang="ar"> 
  <div class="challenge-header"> 
    <h2>استكمال المخطط المفاهيمي: التمثيل الضوئي</h2> 
    <div class="challenge-meta"> 
      <div class="score"> 
        النتيجة: <span>{{currentScore}}/{{maxScore}}</span> 
      </div> 
      <div class="hints"> 
        التلميحات المتبقية: <span>{{remainingHints}}</span> 
      </div> 
    </div> 
  </div>

  <div class="challenge-instructions">
    <p>اسحب المفاهيم من قائمة المفاهيم المتاحة وأفلتها في المواقع الصحيحة على المخطط المفاهيمي للتمثيل الضوئي. انقر على أيقونة المصباح للحصول على تلميح.</p>
  </div>

  <div class="challenge-content">
    <div class="concept-map-workspace">
      <div class="concepts-panel">
        <h3>المفاهيم المتاحة</h3>
        <div 
          cdkDropList
          #availableList="cdkDropList"
          [cdkDropListData]="availableConcepts"
          [cdkDropListConnectedTo]="[placedList]"
          class="concepts-container"
          id="availableConcepts"
          (cdkDropListDropped)="drop($event)">
          @for (concept of availableConcepts; track concept.id) {
            <div 
              class="concept-item"
              cdkDrag
              [cdkDragData]="concept">
              {{concept.text}}
            </div>
          }
          @if (isAvailableListEmpty()) {
            <div class="empty-list-message">
              جميع المفاهيم تم نقلها. اسحبها من المنطقة أدناه إلى المواقع الصحيحة في المخطط
            </div>
          }
        </div>
        
        <h3>المفاهيم المحددة</h3>
        <div 
          cdkDropList
          #placedList="cdkDropList"
          [cdkDropListData]="placedConcepts"
          [cdkDropListConnectedTo]="[availableList]"
          class="concepts-container"
          id="placedConcepts"
          (cdkDropListDropped)="drop($event)">
          @for (concept of placedConcepts; track concept.id) {
            <div 
              class="concept-item"
              cdkDrag
              [cdkDragData]="concept">
              {{concept.text}}
            </div>
          }
          @if (isPlacedListEmpty()) {
            <div class="empty-list-message">
              اسحب المفاهيم هنا ثم ضعها في المواقع المناسبة على المخطط
            </div>
          }
        </div>
      </div>
      
      <div class="concept-map-container">
        <div class="concept-map-diagram">
          <img src="assets/images/photosynthesis-concept-map-blank.png" alt="مخطط التمثيل الضوئي">
          
          @for (placeholder of placeholders; track placeholder.id) {
            <div 
              class="placeholder-container"
              [attr.data-placeholder-id]="placeholder.id"
              [class.has-concept]="hasAssignedConcept(placeholder)"
              [class.is-correct]="placeholder.isCorrect"
              [class.is-incorrect]="isPlaceholderIncorrect(placeholder)">
              <div class="hint-button" (click)="showHint(placeholder)">
                <i class="fa fa-lightbulb"></i>
              </div>
              
              @if (hasAssignedConcept(placeholder)) {
                <div class="placed-concept">
                  {{ getConceptText(placeholder) }}
                  <button class="remove-concept" (click)="removeFromPlaceholder(placeholder)">
                    <i class="fa fa-times"></i>
                  </button>
                </div>
              } @else {
                <div 
                  class="concept-dropzone"
                  cdkDropList
                  [cdkDropListConnectedTo]="[placedList]"
                  (cdkDropListDropped)="assignConceptToPlaceholder($event, placeholder)">
                  <div class="dropzone-placeholder">
                    أفلت هنا
                  </div>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
    
    @if (activeHint) {
      <div class="hint-modal">
        <div class="hint-content">
          <div class="hint-header">
            <h4>تلميح</h4>
            <button class="close-hint" (click)="closeHint()">
              <i class="fa fa-times"></i>
            </button>
          </div>
          <p>{{activeHint}}</p>
        </div>
      </div>
    }
    
    @if (showFeedback) {
      <div class="feedback-panel">
        <div class="feedback-header">
          <h3>نتائج المخطط المفاهيمي</h3>
        </div>
        <div class="feedback-content">
          <p>لقد وضعت {{getPlacedConceptsCount()}} من أصل {{placeholders.length}} مفاهيم.</p>
          <p>المفاهيم الصحيحة: {{getCorrectConceptsCount()}} من أصل {{placeholders.length}}.</p>
          
          @if (areAllConceptsCorrect()) {
            <div class="success-message">
              <i class="fa fa-check-circle"></i>
              أحسنت! لقد أكملت المخطط المفاهيمي بشكل صحيح.
            </div>
          } @else {
            <div class="partial-success-message">
              <i class="fa fa-info-circle"></i>
              هناك بعض المفاهيم في غير موضعها الصحيح. حاول مرة أخرى لتحسين نتيجتك.
            </div>
          }
        </div>
        <div class="feedback-actions">
          @if (areAllConceptsCorrect()) {
            <button class="finish-btn" (click)="finishChallenge()">
              إنهاء
            </button>
          } @else {
            <button class="retry-btn" (click)="restartChallenge()">
              إعادة المحاولة
            </button>
          }
        </div>
      </div>
    }
  </div>

  <div class="challenge-footer">
    <button 
      class="check-answers-btn" 
      [disabled]="!hasAnyPlacedConcepts()"
      (click)="checkCompletion()">
      تحقق من إجاباتك
    </button>
  </div>
</div>
