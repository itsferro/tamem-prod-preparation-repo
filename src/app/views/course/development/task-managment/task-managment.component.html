<!-- task-managment.component.html - Enhanced with Course Filter -->

<!-- Admin Tasks Dashboard Header -->
<div class="container-fluid">
    <!-- Statistics Cards -->
    <div class="row mb-4">
      <div class="col-lg-2 col-md-4 col-6">
        <div class="stats-card primary">
          <div class="icon">
            <i class="fas fa-tasks"></i>
          </div>
          <div class="number">{{ taskStats.total }}</div>
          <div class="label">Total Tasks</div>
          <div class="change text-primary">
            <i class="fas fa-star"></i> {{ taskStats.totalPoints }} pts
          </div>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-6">
        <div class="stats-card warning">
          <div class="icon">
            <i class="fas fa-play-circle"></i>
          </div>
          <div class="number">{{ taskStats.inProgress }}</div>
          <div class="label">In Progress</div>
          <div class="change text-warning">
            <i class="fas fa-clock"></i> Active now
          </div>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-6">
        <div class="stats-card warning">
          <div class="icon">
            <i class="fas fa-play-circle"></i>
          </div>
          <div class="number">{{ taskStats.review }}</div>
          <div class="label">Review</div>
          <div class="change text-warning">
            <i class="fas fa-clock"></i> Active now
          </div>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-6">
        <div class="stats-card success">
          <div class="icon">
            <i class="fas fa-check-circle"></i>
          </div>
          <div class="number">{{ taskStats.approved }}</div>
          <div class="label">Approved</div>
          <div class="change text-success">
            <i class="fas fa-check"></i> Completed
          </div>
        </div>
      </div>
      <div class="col-lg-2 col-md-4 col-6">
        <div class="stats-card danger">
          <div class="icon">
            <i class="fas fa-user-times"></i>
          </div>
          <div class="number">{{ taskStats.unassignedTasks }}</div>
          <div class="label">Unassigned</div>
          <div class="change text-danger">
            <i class="fas fa-exclamation"></i> Need assignment
          </div>
        </div>
      </div>
      <!-- <div class="col-lg-2 col-md-4 col-6">
        <div class="stats-card info">
          <div class="icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="number">{{ formatMinutes(taskStats.totalActualMinutes) }}</div>
          <div class="label">Time Spent</div>
          <div class="change text-info">
            <i class="fas fa-hourglass"></i> Actual work
          </div>
        </div>
      </div> -->
      <div class="col-lg-2 col-md-4 col-6">
        <div class="stats-card secondary">
          <div class="icon">
            <i class="fas fa-list"></i>
          </div>
          <div class="number">{{ taskStats.backlog }}</div>
          <div class="label">Backlog</div>
          <div class="change text-muted">
            <i class="fas fa-pause"></i> Pending
          </div>
        </div>
      </div>
    </div>
  
    <!-- Loading State -->
    @if (isLoading) {
      <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading admin tasks...</p>
      </div>
    }
  
    <!-- Error State -->
    @if (errorMessage) {
      <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ errorMessage }}
        <button class="btn btn-sm btn-outline-danger ms-2" (click)="refreshTasks()">
          <i class="fas fa-sync-alt me-1"></i>Retry
        </button>
      </div>
    }
  
    <!-- Tasks Section -->
    <div class="tasks-section">
      <!-- Tasks Header -->
      <div class="tasks-header">
        <div class="d-flex justify-content-between align-items-center">
          <h4>
            <i class="fas fa-list me-2"></i>
            Development Tasks Overview
          </h4>
          <div class="d-flex gap-2 align-items-center">
            <!-- Course Filter Selectbox - NEW -->
            <div class="course-filter-container">
              <label class="form-label text-white mb-1 small">
                <i class="fas fa-graduation-cap me-1"></i>Filter by Course:
              </label>
              <select class="form-select form-select-sm course-select" 
                      [(ngModel)]="selectedCourse" 
                      (ngModelChange)="onCourseSelectionChange()">
                <option value="all">All Courses ({{ getAllCoursesCount() }})</option>
                @for (course of uniqueCourses; track course) {
                  <option [value]="course">{{ course }} ({{ getCourseTaskCount(course) }})</option>
                }
              </select>
            </div>
  
            <!-- User Filter Selectbox -->
            <div class="user-filter-container">
              <label class="form-label text-white mb-1 small">
                <i class="fas fa-user me-1"></i>Filter by User:
              </label>
              <select class="form-select form-select-sm user-select" 
                      [(ngModel)]="selectedUser" 
                      (ngModelChange)="onUserSelectionChange()">
                <option value="all">All Users ({{ getAllUsersCount() }})</option>
                @for (user of uniqueUsers; track user) {
                  <option [value]="user">{{ user }} ({{ getUserTaskCount(user) }})</option>
                }
              </select>
            </div>
            
            <button class="btn btn-light btn-sm" (click)="refreshTasks()">
              <i class="fas fa-sync-alt me-1"></i>
              Refresh
            </button>
            <button class="btn btn-light btn-sm">
              <i class="fas fa-download me-1"></i>
              Export
            </button>
          </div>
        </div>
      </div>
  
      <!-- Filter Tabs -->
      <div class="filter-tabs">
        <ul class="nav nav-tabs border-0">
          <li class="nav-item">
            <a class="nav-link" 
               [class.active]="currentFilter === 'all'"
               (click)="setFilter('all')"
               href="javascript:void(0);">
              <i class="fas fa-list me-1"></i>
              All Tasks ({{ getFilterCount('all') }})
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" 
               [class.active]="currentFilter === 'backlog'"
               (click)="setFilter('backlog')"
               href="javascript:void(0);">
              <i class="fas fa-pause me-1"></i>
              Backlog ({{ getFilterCount('backlog') }})
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" 
               [class.active]="currentFilter === 'to-do'"
               (click)="setFilter('to-do')"
               href="javascript:void(0);">
              <i class="fas fa-plus me-1"></i>
              To Do ({{ getFilterCount('to-do') }})
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" 
               [class.active]="currentFilter === 'in-progress'"
               (click)="setFilter('in-progress')"
               href="javascript:void(0);">
              <i class="fas fa-play me-1"></i>
              In Progress ({{ getFilterCount('in-progress') }})
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" 
               [class.active]="currentFilter === 'review'"
               (click)="setFilter('review')"
               href="javascript:void(0);">
              <i class="fas fa-play me-1"></i>
              Review ({{ getFilterCount('review') }})
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" 
               [class.active]="currentFilter === 'approved'"
               (click)="setFilter('approved')"
               href="javascript:void(0);">
              <i class="fas fa-check me-1"></i>
              Approved ({{ getFilterCount('approved') }})
            </a>
          </li>
          <!-- <li class="nav-item">
            <a class="nav-link" 
               [class.active]="currentFilter === 'unassigned'"
               (click)="setFilter('unassigned')"
               href="javascript:void(0);">
              <i class="fas fa-user-times me-1"></i>
              Unassigned ({{ getFilterCount('unassigned') }})
            </a>
          </li> -->
          <li class="nav-item">
            <a class="nav-link" 
               [class.active]="currentFilter === 'needs-help'"
               (click)="setFilter('needs-help')"
               href="javascript:void(0);">
              <i class="fas fa-question-circle me-1"></i>
              Needs Help ({{ getFilterCount('needs-help') }})
            </a>
          </li>
        </ul>
  
        <!-- Enhanced Filter Indicators Panel -->
        @if (selectedUser !== 'all' || selectedCourse !== 'all') {
          <div class="filter-indicators mt-2">
            <!-- Course Filter Indicator - NEW -->
            @if (selectedCourse !== 'all') {
              <div class="alert alert-warning alert-sm mb-2 py-2">
                <i class="fas fa-graduation-cap me-2"></i>
                <strong>Filtered by course:</strong> 
                <span class="course-badge">
                  <div class="course-icon-small me-1">
                    <i class="fas fa-book"></i>
                  </div>
                  {{ selectedCourse }}
                </span>
                <button class="btn btn-sm btn-outline-warning ms-2" 
                        (click)="selectedCourse = 'all'; onCourseSelectionChange()"
                        title="Clear course filter">
                  <i class="fas fa-times"></i> Clear Course Filter
                </button>
              </div>
            }
  
            <!-- User Filter Indicator -->
            @if (selectedUser !== 'all') {
              <div class="alert alert-info alert-sm mb-2 py-2">
                <i class="fas fa-filter me-2"></i>
                <strong>Filtered by user:</strong> 
                <span class="user-badge">
                  <div class="user-avatar-small me-1">{{ getUserInitials(selectedUser) }}</div>
                  {{ selectedUser }}
                </span>
                <button class="btn btn-sm btn-outline-info ms-2" 
                        (click)="selectedUser = 'all'; onUserSelectionChange()"
                        title="Clear user filter">
                  <i class="fas fa-times"></i> Clear User Filter
                </button>
              </div>
            }
  
            <!-- Clear All Filters Button -->
            @if (selectedUser !== 'all' || selectedCourse !== 'all') {
              <div class="text-center mt-2">
                <button class="btn btn-outline-secondary btn-sm" 
                        (click)="clearAllFilters()"
                        title="Clear all filters">
                  <i class="fas fa-eraser me-1"></i> Clear All Filters
                </button>
              </div>
            }
          </div>
        }
      </div>
  
      <!-- Tasks Table -->
      <div class="table-responsive">
        <table class="table admin-tasks-table">
          <thead>
            <tr>
              <th width="5%">Priority</th>
              <th width="20%">Task Details</th>
              <th width="10%">Status</th>
              <th width="12%">Assigned To</th>
              <th width="12%">Time Tracking</th>
              <th width="8%">Points</th>
              <th width="10%">Help Requests</th>
              <th width="10%">Last Updated</th>
              <th width="8%">Actions</th>
            </tr>
          </thead>
          <tbody>
            @if (filteredTasks.length === 0) {
              <tr>
                <td colspan="9">
                  <div class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <h5>No admin tasks found</h5>
                    @if (selectedUser !== 'all' || selectedCourse !== 'all') {
                      <p class="mb-2">No tasks found with the current filter criteria:</p>
                      <div class="current-filters mb-3">
                        @if (selectedCourse !== 'all') {
                          <span class="badge bg-warning text-dark me-2">
                            <i class="fas fa-graduation-cap me-1"></i>Course: {{ selectedCourse }}
                          </span>
                        }
                        @if (selectedUser !== 'all') {
                          <span class="badge bg-info me-2">
                            <i class="fas fa-user me-1"></i>User: {{ selectedUser }}
                          </span>
                        }
                      </div>
                      <button class="btn btn-outline-primary btn-sm" 
                              (click)="clearAllFilters()">
                        <i class="fas fa-eraser me-1"></i>Clear All Filters
                      </button>
                    } @else {
                      <p class="mb-0">No tasks match your current filter criteria.</p>
                    }
                  </div>
                </td>
              </tr>
            } @else {
              @for (task of paginatedTasks; track task.id) {
                <tr [class]="getStatusRowClass(task.status) + ' ' + getPriorityClass(task)">
                  <td>
                    <div class="priority-indicator" [class]="getPriorityClass(task)"></div>
                  </td>
                  <td>
                    <div class="task-details">
                      <div class="task-title">
                        <i [class]="task.taskIconClass + ' me-2'" [style.color]="getTaskPhaseColor(task.taskName)"></i>
                        {{ task.taskShortName }}
                      </div>
                      <div class="task-id"> 
                        <span>Course: {{ task.courseName }}</span> - 
                        <span>Lesson: {{ task.lessonName }}</span>   
                      </div>
                      <div class="task-id">Block: {{ task.blockName }}</div>
                    </div>
                  </td>
                  <td>
                    <span class="status-badge" [ngClass]="getStatusClass(task.status)">
                      {{ getStatusLabel(task.status) }}
                    </span>
                  </td>
                  <td>
                    <div class="assigned-user">
                      <div class="user-avatar" [class.unassigned]="task.assignedToUserName === 'Unassigned'">
                        {{ getUserInitials(task.assignedToUserName) }}
                      </div>
                      <div class="user-info">
                        <div class="user-name">{{ task.assignedToUserName }}</div>
                        <div class="assigned-by">by {{ task.assignedByUserName }}</div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="time-tracking">
                      <div class="time-item">
                        <span class="time-label">Estimated:</span>
                        <strong>{{ formatMinutes(task.estimatedWorkingMinutes) }}</strong>
                      </div>
                      <div class="time-item">
                        <span class="time-label">Actual:</span>
                        <strong [class.over-estimate]="task.actualWorkingMinutes > task.estimatedWorkingMinutes">
                          {{ formatMinutes(task.actualWorkingMinutes) }}
                        </strong>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="text-center">
                      <strong class="points-value">{{ task.estimatedPoints }}</strong>
                      <div class="text-muted small">pts</div>
                    </div>
                  </td>
                  <td>
                    <div class="help-requests">
                      @if (task.counterHelp > 0) {
                        <div class="help-item critical">
                          <i class="fas fa-question-circle me-1"></i>
                          <span>{{ task.counterHelp }} help</span>
                        </div>
                      }
                      @if (task.counterRefuse > 0) {
                        <div class="help-item warning">
                          <i class="fas fa-times-circle me-1"></i>
                          <span>{{ task.counterRefuse }} refuse</span>
                        </div>
                      }
                      @if (task.counterReopen > 0) {
                        <div class="help-item info">
                          <i class="fas fa-redo me-1"></i>
                          <span>{{ task.counterReopen }} reopen</span>
                        </div>
                      }
                      @if (task.counterHelp === 0 && task.counterRefuse === 0 && task.counterReopen === 0) {
                        <span class="text-muted">—</span>
                      }
                    </div>
                  </td>
                  <td>
                    <div class="last-updated">
                      <div class="update-time">{{ formatLastUpdated(task.lastUpdatedAt) }}</div>
                      @if (task.lastUpdatedByUserName) {
                        <div class="updated-by">by {{ task.lastUpdatedByUserName }}</div>
                      } @else {
                        <div class="updated-by text-muted">—</div>
                      }
                    </div>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn-action btn-view" 
                              title="View Task Details"
                              (click)="openTaskTrack(task)">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
  
      <!-- Pagination -->
      @if (filteredTasks.length > pageSize) {
        <div class="d-flex justify-content-between align-items-center p-3 bg-light">
          <div class="text-muted">
            Showing {{ getStartIndex() }}-{{ getEndIndex() }} of {{ filteredTasks.length }} tasks
            @if (selectedUser !== 'all' || selectedCourse !== 'all') {
              <span class="ms-2">
                <i class="fas fa-filter me-1"></i>
                with active filters
                @if (selectedCourse !== 'all') {
                  <span class="badge bg-warning text-dark ms-1">{{ selectedCourse }}</span>
                }
                @if (selectedUser !== 'all') {
                  <span class="badge bg-info ms-1">{{ selectedUser }}</span>
                }
              </span>
            }
          </div>
        </div>
      }
    </div>
  </div>
  
  <!-- Bottom spacing -->
  <div style="margin-bottom: 80px;"></div>