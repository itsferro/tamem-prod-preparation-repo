<app-menu navClassName="container" menuClassName="mx-auto" [SearchWithText]="true" />

<main dir="rtl" class="rtl-layout">
  <div class="page-header bg-light-subtle">
    <div class="container">
 
    </div>
  </div>

  <div class="action-tracking-page">
    <div class="container-fluid py-4">
      <!-- Header section with navigation -->
      <div class="header-section mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <h2 class="mb-0 d-flex align-items-center">
            <span class="icon-circle primary me-3">
              <i class="fas fa-tasks"></i>
            </span>
            @if (loading) {
              <span>سجل التطوير: جاري التحميل...</span>
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            } @else if (error) {
              <span class="text-danger">{{ error }}</span>
            } @else if (lessonBlock?.block) {
              <span>سجل التطوير: <span class="text-primary">{{ lessonBlock.lesson_name || 'الدرس' }}</span> / <span class="fw-bold">{{ lessonBlock.block.title }}</span></span>
            } @else {
              <span>سجل التطوير</span>
            }
          </h2>
          <div class="block-navigation">
            <button type="button" class="btn btn-outline-primary me-2" (click)="goToPreviousBlock()" [disabled]="Number(blockId) <= 1">
              <i class="fas fa-chevron-right ms-1"></i> الوحدة السابقة
            </button>
            <button type="button" class="btn btn-outline-primary" (click)="goToNextBlock()">
              الوحدة التالية <i class="fas fa-chevron-left ms-1"></i>
            </button>
          </div>
        </div>
        <hr>
      </div>
  
      <!-- Loading and error states -->
      <div *ngIf="loading" class="text-center py-5 loading-container">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">جاري التحميل...</span>
        </div>
        <p class="mb-0 text-muted">جاري تحميل سجل الإجراءات...</p>
      </div>
  
      <div *ngIf="error && !loading" class="alert alert-danger d-flex align-items-center" role="alert">
        <div class="alert-icon me-3">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div>{{ error }}</div>
      </div>
  
      <!-- Main content when data is loaded -->
      <div *ngIf="!loading && !error" class="action-tracking">
        <!-- Add Action Button -->
        <div class="d-flex mb-4">
          <button type="button" class="btn btn-primary add-action-btn" (click)="openAddActionModal()">
            <i class="fas fa-plus-circle ms-2"></i> إضافة إجراء جديد
          </button>
        </div>
        
        <!-- Actions History Card -->
        <div class="card mb-4">
          <div class="card-header bg-light">
            <h5 class="mb-0">
              <i class="fas fa-history ms-2"></i> سجل الإجراءات
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-bordered table-hover action-history-table">
                <thead class="table-light">
                  <tr>
                    <th>الإجراء</th>
                    <th>التاريخ</th>
                    <th>المستخدم</th>
                    <th>ملاحظات</th>
                    <th>مرحلة العملية</th>
                    <th>الحالة</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Show existing actions -->
                  <tr *ngFor="let action of actions">
                    <td><span class="badge bg-light text-dark">{{ getActionLabel(action.action) }}</span></td>
                    <td>{{ action.timestamp | date:'short' }}</td>
                    <td>
                      <div class="d-flex align-items-center">
                        <span class="avatar-icon me-2">
                          <i class="fas fa-user"></i>
                        </span>
                        {{ action.user }}
                      </div>
                    </td>
                    <td>{{ action.notes }}</td>
                    <td><span class="process-badge">{{ getProcessPartLabel(action.processPart) }}</span></td>
                    <td>
                      <span [ngClass]="getStatusClass(action.status)">
                        {{ getStatusLabel(action.status) }}
                      </span>
                    </td>
                  </tr>
                  
                  <!-- Empty state if no actions -->
                  <tr *ngIf="!actions || actions.length === 0">
                    <td colspan="6" class="text-center py-4 empty-state">
                      <i class="fas fa-clipboard-list fa-2x text-muted mb-3"></i>
                      <p class="mb-0">لا توجد إجراءات مسجلة لهذه الوحدة</p>
                      <small class="text-muted">أضف إجراء جديد للبدء في تتبع التطوير</small>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Help Card -->
        <div class="card mb-4">
          <div class="card-header bg-light">
            <h5 class="mb-0">
              <i class="fas fa-info-circle ms-2"></i> دليل مراحل التطوير
            </h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <h6 class="mb-3 text-primary">مراحل العملية:</h6>
                <ul class="dev-stages">
                  <li><strong>الإعداد الأولي</strong> - بدء العمل على الوحدة</li>
                  <li><strong>إنشاء المحتوى</strong> - إضافة المحتوى النصي</li>
                  <li><strong>تصميم لوحة القصة</strong> - إنشاء لوحة القصة</li>
                  <li><strong>الصور الخارجية</strong> - إضافة الصور الخارجية</li>
                  <li><strong>تصميم استوديو الإنشاء</strong> - إنشاء تصاميم في الاستوديو</li>
                  <li><strong>المراجعة النهائية</strong> - المراجعة النهائية والتسليم</li>
                </ul>
              </div>
              <div class="col-md-6">
                <h6 class="mb-3 text-primary">أنواع الحالات:</h6>
                <ul class="dev-stages">
                  <li class="status-ongoing"><strong>قيد التنفيذ</strong> - العمل جارٍ</li>
                  <li class="status-issues"><strong>يواجه مشاكل</strong> - هناك مشاكل في التنفيذ</li>
                  <li class="status-help"><strong>يحتاج مساعدة</strong> - مطلوب المساعدة</li>
                  <li class="status-stuck"><strong>متوقف</strong> - توقف العمل</li>
                  <li class="status-done"><strong>مكتمل</strong> - انتهت المرحلة</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Save changes button -->
        <div class="d-flex justify-content-start mb-4">
          <button type="button" class="btn btn-primary btn-lg" (click)="saveActions(true).subscribe()">
            <i class="fas fa-save ms-1"></i> حفظ التغييرات
          </button>
        </div>
      </div>
    </div>
  </div> 

  <!-- Add Action Modal -->
  <div class="action-modal" [class.show]="showAddActionModal">
    <div class="modal-backdrop" (click)="closeAddActionModal()"></div>
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-plus-circle ms-2"></i> إضافة إجراء جديد
          </h5>
          <button type="button" class="close-btn" aria-label="Close" (click)="closeAddActionModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <!-- Process Part Selection -->
            <div class="col-md-6 mb-3">
              <label for="newActionProcessPart" class="form-label">مرحلة العملية</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-layer-group"></i></span>
                <select class="form-select" id="newActionProcessPart" [(ngModel)]="newAction.processPart" name="processPart">
                  <option value="">-- اختر المرحلة --</option>
                  <option *ngFor="let part of processPartOptions" [value]="part.value">
                    {{ part.label }}
                  </option>
                </select>
              </div>
            </div>
            
            <!-- Status Selection -->
            <div class="col-md-6 mb-3">
              <label for="newActionStatus" class="form-label">الحالة</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-flag"></i></span>
                <select class="form-select" id="newActionStatus" [(ngModel)]="newAction.status" name="status">
                  <option value="">-- اختر الحالة --</option>
                  <option *ngFor="let status of statusOptions" [value]="status.value">
                    {{ status.label }}
                  </option>
                </select>
              </div>
            </div>
            
            <!-- Notes -->
            <div class="col-12 mb-3">
              <label for="newActionNotes" class="form-label">ملاحظات</label>
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-comment-alt"></i></span>
                <textarea class="form-control" id="newActionNotes" rows="3" 
                          [(ngModel)]="newAction.notes" name="notes" 
                          placeholder="أضف ملاحظات حول هذا الإجراء..."></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeAddActionModal()">
            <i class="fas fa-times ms-1"></i> إلغاء
          </button>
          <button type="button" class="btn btn-primary" (click)="addNewActionFromModal()" 
                  [disabled]="!newAction.processPart || !newAction.status">
            <i class="fas fa-plus ms-1"></i> إضافة إجراء
          </button>
        </div>
      </div>
    </div>
  </div>
</main> 