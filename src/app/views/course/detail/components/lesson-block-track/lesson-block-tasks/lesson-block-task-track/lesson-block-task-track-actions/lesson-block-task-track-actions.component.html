<!-- Dynamic Field Visibility Actions Component -->
<div class="actions-panel">
  <div class="actions-header">
    <h6>
      <i class="fas fa-tools me-2"></i>
      Available Actions for "{{ selectedStatus?.status_label || 'Current Status' }}"
    </h6>
    @if (isLoadingActions) {
    <span class="badge bg-secondary">Loading...</span>
    } @else {
    <span class="badge bg-primary">{{ availableActions.length }} actions</span>
    }
  </div>

  <!-- Loading Actions -->
  @if (isLoadingActions) {
  <div class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading actions...</span>
    </div>
    <p class="mt-2 text-muted">Loading available actions...</p>
  </div>
  }

  <!-- Actions Error -->
  @else if (actionsError) {
  <div class="alert alert-warning" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ actionsError }}
  </div>
  }

  <!-- No actions available -->
  @else if (availableActions.length === 0) {
  <div class="no-actions">
    <i class="fas fa-info-circle fa-2x text-muted mb-2"></i>
    <p class="mb-0 text-muted">No actions available for current status</p>
  </div>
  }

  <!-- Actions Grid -->
  @else {
  <div class="actions-grid">
    @for (action of availableActions; track action.key) {
    <div class="action-card"
      [ngClass]="{'action-member': action.type === 'member', 'action-admin': action.type === 'admin', 'action-selected': isActionSelected(action.key)}"
      (click)="selectAction(action.key)">
      <div class="action-icon">
        <i [class]="getActionIconClass(action)"></i>
      </div>
      <div class="action-content">
        <div class="action-title">{{ action.title }}</div>
        <div class="action-description">{{ action.description }}</div>
        <div class="action-target">
          <i class="fas fa-arrow-right me-1"></i>
          Changes to: <strong>{{ getActionTargetStatus(action) }}</strong>
        </div>
      </div>
    </div>
    }
  </div>
  }
</div>

<!-- Universal Action Form - Dynamic Field Visibility -->
@if (selectedAction) {
<div class="action-modal-overlay" (click)="cancelAction()">
  <div class="action-modal-popup" (click)="$event.stopPropagation()">
    <div class="action-form-panel">
      <div class="action-form-header">
        <h6>
          <i class="fas fa-edit me-2"></i>
          Complete Action: "{{ getActionTitle(selectedAction) }}"
        </h6>
        <button class="btn btn-sm btn-outline-light" (click)="cancelAction()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="action-form-content">
        <div class="action-form">

          <!-- Dynamic Form Fields Container -->
          <div class="form-group-container">

            <!-- Assignment & Due Date Row -->
            @if (hasVisibleFields(['assignedToUserId', 'dueDate'])) {
            <div class="row">
              <!-- Assign to Member -->
              @if (isFieldVisible('assignedToUserId')) {
              <div class="col-md-8">
                <label class="form-label">
                  <i class="fas fa-user me-1"></i>
                  Assign to Member
                  @if (isFieldRequired('assignedToUserId')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <select class="form-select" [(ngModel)]="actionForm.assignedToUserId"
                  [class.is-invalid]="hasValidationError('assignedToUserId')"
                  [required]="isFieldRequired('assignedToUserId')">
                  <option value="">Select team member</option>
                  @for (member of teamMembers; track member.id) {
                  <option [value]="member.id">{{ member.name }}</option>
                  }
                </select>
                <small class="form-text text-muted">Choose who will be responsible for this task</small>
                @if (hasValidationError('assignedToUserId')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('assignedToUserId') }}
                </div>
                }
              </div>
              }

              <!-- Due Date -->
              @if (isFieldVisible('dueDate')) {
              <div [class]="isFieldVisible('assignedToUserId') ? 'col-md-4' : 'col-md-12'">
                <label class="form-label">
                  <i class="fas fa-calendar me-1"></i>
                  Due Date
                  @if (isFieldRequired('dueDate')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <input type="date" class="form-control" [(ngModel)]="actionForm.dueDate"
                  [class.is-invalid]="hasValidationError('dueDate')" [required]="isFieldRequired('dueDate')">
                <small class="form-text text-muted">Task deadline</small>
                @if (hasValidationError('dueDate')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('dueDate') }}
                </div>
                }
              </div>
              }
            </div>
            }

            <!-- Time & Quality Row -->
            @if (hasVisibleFields(['actualWorkingMinutes', 'qualityScore'])) {
            <div class="row">
              <!-- Actual Working Time -->
              @if (isFieldVisible('actualWorkingMinutes')) {
              <div class="col-md-6">
                <label class="form-label">
                  <i class="fas fa-clock me-1"></i>
                  Actual Working Time (minutes)
                  @if (isFieldRequired('actualWorkingMinutes')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <input type="number" class="form-control" [(ngModel)]="actionForm.actualWorkingMinutes"
                  placeholder="Enter actual time spent" min="1" max="999"
                  [class.is-invalid]="hasValidationError('actualWorkingMinutes')"
                  [required]="isFieldRequired('actualWorkingMinutes')">
                <small class="form-text text-muted">
                  Estimated: {{ getEstimatedTime() }} minutes
                </small>
                @if (hasValidationError('actualWorkingMinutes')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('actualWorkingMinutes') }}
                </div>
                }
              </div>
              }

              <!-- Quality Score -->
              @if (isFieldVisible('qualityScore')) {
              <div [class]="isFieldVisible('actualWorkingMinutes') ? 'col-md-6' : 'col-md-12'">
                <label class="form-label">
                  <i class="fas fa-trophy me-1"></i>
                  Quality Score (1-10)
                  @if (isFieldRequired('qualityScore')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <input type="number" class="form-control" [(ngModel)]="actionForm.qualityScore"
                  placeholder="Enter quality score" min="1" max="10"
                  [class.is-invalid]="hasValidationError('qualityScore')" [required]="isFieldRequired('qualityScore')">
                <small class="form-text text-muted">Detailed quality assessment</small>
                @if (hasValidationError('qualityScore')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('qualityScore') }}
                </div>
                }
              </div>
              }
            </div>
            }

            <!-- Help & Support Row -->
            @if (hasVisibleFields(['helpType', 'helpLevel'])) {
            <div class="row">
              <!-- Help Type -->
              @if (isFieldVisible('helpType')) {
              <div class="col-md-6">
                <label class="form-label">
                  <i class="fas fa-exclamation-circle me-1"></i>
                  Help Type
                  @if (isFieldRequired('helpType')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <select class="form-select" [(ngModel)]="actionForm.helpType"
                  [class.is-invalid]="hasValidationError('helpType')" [required]="isFieldRequired('helpType')">
                  <option value="">Select help type</option>
                  <option value="technical">Technical Issue</option>
                  <option value="clarification">Need Clarification</option>
                  <option value="resources">Missing Resources</option>
                  <option value="approval">Need Approval</option>
                  <option value="review">Quick Review</option>
                  <option value="other">Other</option>
                </select>
                <small class="form-text text-muted">What kind of help is needed</small>
                @if (hasValidationError('helpType')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('helpType') }}
                </div>
                }
              </div>
              }

              <!-- Help Level -->
              @if (isFieldVisible('helpLevel')) {
              <div [class]="isFieldVisible('helpType') ? 'col-md-6' : 'col-md-12'">
                <label class="form-label">
                  <i class="fas fa-tachometer-alt me-1"></i>
                  Help Level
                  @if (isFieldRequired('helpLevel')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <select class="form-select" [(ngModel)]="actionForm.helpLevel"
                  [class.is-invalid]="hasValidationError('helpLevel')" [required]="isFieldRequired('helpLevel')">
                  <option value="low">Low - Can wait</option>
                  <option value="medium">Medium - Normal</option>
                  <option value="high">High - Urgent</option>
                  <option value="critical">Critical - Blocking</option>
                </select>
                <small class="form-text text-muted">How urgent is this request</small>
                @if (hasValidationError('helpLevel')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('helpLevel') }}
                </div>
                }
              </div>
              }
            </div>
            }


            <!-- Links Row -->
            @if (hasVisibleFields(['canvaLink', 'googleDriveLink'])) {
            <div class="row">
              <!-- Canva Link -->
              @if (isFieldVisible('canvaLink')) {
              <div class="col-md-6">
                <label class="form-label">
                  <i class="fab fa-canva me-1"></i>
                  Canva Design Link
                  @if (isFieldRequired('canvaLink')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <input type="url" class="form-control" [(ngModel)]="actionForm.canvaLink"
                  placeholder="https://canva.com/design/..." [class.is-invalid]="hasValidationError('canvaLink')"
                  [required]="isFieldRequired('canvaLink')">
                <small class="form-text text-muted">Link to the Canva design file</small>
                @if (hasValidationError('canvaLink')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('canvaLink') }}
                </div>
                }
              </div>
              }

              <!-- Google Drive Link -->
              @if (isFieldVisible('googleDriveLink')) {
              <div [class]="isFieldVisible('canvaLink') ? 'col-md-6' : 'col-md-12'">
                <label class="form-label">
                  <i class="fab fa-google-drive me-1"></i>
                  Google Drive Link
                  @if (isFieldRequired('googleDriveLink')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <input type="url" class="form-control" [(ngModel)]="actionForm.googleDriveLink"
                  placeholder="https://drive.google.com/..." [class.is-invalid]="hasValidationError('googleDriveLink')"
                  [required]="isFieldRequired('googleDriveLink')">
                <small class="form-text text-muted">Link to Google Drive folder/file</small>
                @if (hasValidationError('googleDriveLink')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('googleDriveLink') }}
                </div>
                }
              </div>
              }
            </div>
            }


            <!-- Performance & Review Row -->
            @if (hasVisibleFields(['performanceRating', 'rejectionReason'])) {
            <div class="row">
              <!-- Performance Rating -->
              @if (isFieldVisible('performanceRating')) {
              <div class="col-md-6">
                <label class="form-label">
                  <i class="fas fa-medal me-1"></i>
                  Performance Rating
                  @if (isFieldRequired('performanceRating')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <select class="form-select" [(ngModel)]="actionForm.performanceRating"
                  [class.is-invalid]="hasValidationError('performanceRating')"
                  [required]="isFieldRequired('performanceRating')">
                  <option value="">Select rating</option>
                  <option value="exceeds">Exceeds Expectations</option>
                  <option value="meets">Meets Expectations</option>
                  <option value="below">Below Expectations</option>
                </select>
                <small class="form-text text-muted">Overall performance assessment</small>
                @if (hasValidationError('performanceRating')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('performanceRating') }}
                </div>
                }
              </div>
              }

              <!-- Rejection Reason -->
              @if (isFieldVisible('rejectionReason')) {
              <div [class]="isFieldVisible('performanceRating') ? 'col-md-6' : 'col-md-12'">
                <label class="form-label">
                  <i class="fas fa-times-circle me-1"></i>
                  Rejection Reason
                  @if (isFieldRequired('rejectionReason')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <select class="form-select" [(ngModel)]="actionForm.rejectionReason"
                  [class.is-invalid]="hasValidationError('rejectionReason')"
                  [required]="isFieldRequired('rejectionReason')">
                  <option value="">Select reason</option>
                  <option value="quality">Quality Issues</option>
                  <option value="requirements">Doesn't Meet Requirements</option>
                  <option value="incomplete">Incomplete Work</option>
                  <option value="guidelines">Doesn't Follow Guidelines</option>
                  <option value="other">Other</option>
                </select>
                <small class="form-text text-muted">Reason for rejection</small>
                @if (hasValidationError('rejectionReason')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('rejectionReason') }}
                </div>
                }
              </div>
              }
            </div>
            }

            <!-- Comments Row -->
            @if (isFieldVisible('comment')) {
            <div class="row">
              <div class="col-12">
                <label class="form-label">
                  <i class="fas fa-edit me-1"></i>
                  Comments & Notes
                  @if (isFieldRequired('comment')) {
                  <span class="text-danger">*</span>
                  }
                </label>
                <textarea class="form-control" rows="4" [(ngModel)]="actionForm.comment"
                  placeholder="Add any comments, notes, or detailed feedback about this action..."
                  [class.is-invalid]="hasValidationError('comment')" [required]="isFieldRequired('comment')"></textarea>
                <small class="form-text text-muted">Provide detailed information about this action</small>
                @if (hasValidationError('comment')) {
                <div class="invalid-feedback">
                  {{ getValidationMessage('comment') }}
                </div>
                }
              </div>
            </div>
            }





            <!-- Additional Options Row -->
            @if (hasVisibleFields(['sendNotification', 'markAsUrgent', 'requiresApproval'])) {
            <div class="row">
              @if (isFieldVisible('sendNotification')) {
              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="sendNotification"
                    [(ngModel)]="actionForm.sendNotification">
                  <label class="form-check-label" for="sendNotification">
                    <i class="fas fa-bell me-1"></i>
                    Send Notification
                  </label>
                </div>
                <small class="form-text text-muted">Notify assigned user</small>
              </div>

              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="noApprovalNeeded"
                    [(ngModel)]="actionForm.noApprovalNeeded">
                  <label class="form-check-label" for="noApprovalNeeded">
                    <i class="fas fa-bell me-1"></i>
                    No Approval Needed
                  </label>
                </div>
                <!-- <small class="form-text text-muted">Notify assigned user</small> -->
              </div>


              }

              @if (isFieldVisible('markAsUrgent')) {
              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="markAsUrgent"
                    [(ngModel)]="actionForm.markAsUrgent">
                  <label class="form-check-label" for="markAsUrgent">
                    <i class="fas fa-exclamation me-1"></i>
                    Mark as Urgent
                  </label>
                </div>
                <small class="form-text text-muted">High priority task</small>
              </div>
              }

              @if (isFieldVisible('requiresApproval')) {
              <div class="col-md-4">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="requiresApproval"
                    [(ngModel)]="actionForm.requiresApproval">
                  <label class="form-check-label" for="requiresApproval">
                    <i class="fas fa-check-double me-1"></i>
                    Requires Approval
                  </label>
                </div>
                <small class="form-text text-muted">Needs manager approval</small>
              </div>
              }
            </div>
            }

          </div>

          <!-- Field Visibility Debug Panel (Development Only) -->
          @if (showDebugPanel) {
          <div class="debug-panel mt-4">
            <h6>Debug: Field Visibility</h6>
            <div class="row">
              <div class="col-md-6">
                <h6>Visible Fields:</h6>
                <ul class="list-unstyled">
                  @for (field of getVisibleFieldsList(); track field) {
                  <li><i class="fas fa-eye text-success"></i> {{ field }}</li>
                  }
                </ul>
              </div>
              <div class="col-md-6">
                <h6>Required Fields:</h6>
                <ul class="list-unstyled">
                  @for (field of getRequiredFieldsList(); track field) {
                  <li><i class="fas fa-asterisk text-danger"></i> {{ field }}</li>
                  }
                </ul>
              </div>
            </div>
          </div>
          }

        </div>
      </div>

      <!-- Action Form Footer -->
      <div class="action-form-footer">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <small class="text-muted">
              <i class="fas fa-info-circle me-1"></i>
              Action: <strong>{{ selectedAction }}</strong> |
              Target Status: <strong>{{ getSelectedActionData()?.target_status || 'Unknown' }}</strong>
              @if (getVisibleFieldsCount() > 0) {
              | Fields: <strong>{{ getVisibleFieldsCount() }}</strong>
              }
            </small>
          </div>
          <div>
            <button class="btn btn-secondary me-2" (click)="cancelAction()" [disabled]="isSubmitting">
              <i class="fas fa-times me-1"></i>
              Cancel
            </button>
            <button class="btn btn-primary" (click)="submitAction()" [disabled]="!isActionFormValid() || isSubmitting">
              @if (isSubmitting) {
              <span class="spinner-border spinner-border-sm me-2" role="status"></span>
              Processing...
              } @else {
              <i class="fas fa-check me-1"></i>
              Confirm Action
              }
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
}