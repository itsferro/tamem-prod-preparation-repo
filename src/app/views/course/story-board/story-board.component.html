<app-menu navClassName="container" menuClassName="mx-auto" [SearchWithText]="true" />

<main>
  <div class="page-header bg-light-subtle">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center py-2 px-3">
        <div class="header-actions">
          <button class="btn btn-outline-primary me-2" (click)="addNewFrame()">
            <i class="fas fa-plus"></i> إطار جديد
          </button>
          <!-- Generate Button with Dropdown Toggle -->
          <div class="btn-group me-2">
            <button class="btn btn-outline-secondary" (click)="generateStoryboard()"
              [disabled]="isGenerating || !lessonBlock?.block?.content">
              <i class="fas fa-magic"></i> توليد تلقائي
              @if (isGenerating) {
              <span class="spinner-border spinner-border-sm ms-1" role="status"></span>
              }
            </button>
            <button type="button" class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split"
              (click)="togglePromptEditor()">
              <span class="visually-hidden">Toggle Dropdown</span>
            </button>
          </div>

          <!-- Save button -->
          <button class="btn btn-success" (click)="saveStoryboard()" [disabled]="isLoading">
            @if (isLoading) {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            <span>جاري الحفظ...</span>
            } @else {
            <i class="fas fa-save me-2"></i> حفظ لوحة القصة
            }
          </button>
        </div>

        <div class="header-title">
          @if (isLoading) {
          <h5 class="mb-0 fw-bold arabic-title">
            <span style="color:rgb(138, 136, 136);"> جاري تحميل العنوان... </span>
            <span class="spinner-border spinner-border-sm text-primary me-2" role="status"></span>
          </h5>
          } @else if (errorMessage) {
          <h5 class="mb-0 fw-bold text-danger arabic-title">
            {{ errorMessage }}
            <i class="fas fa-exclamation-circle me-1"></i>
          </h5>
          } @else if (lessonBlock?.block) {
          <h5 class="mb-0 fw-bold arabic-title">{{ lessonBlock.block.title }}</h5>
          } @else {
          <h5 class="mb-0 fw-bold arabic-title">لوحة الدرس</h5>
          }
        </div>
      </div>
    </div>
  </div>

  <!-- Prompt Editor Panel -->
  @if (showPromptEditor) {
  <div class="prompt-editor-panel container mt-3 mb-3">
    <div class="card">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0">تعليمات توليد اللوحة</h5>
        <button class="btn-close" (click)="togglePromptEditor()"></button>
      </div>
      <div class="card-body">
        <div class="form-group">
          <textarea class="form-control prompt-textarea" rows="10" [(ngModel)]="customPrompt"
            placeholder="Enter AI prompt here..." dir="ltr"></textarea>
        </div>
        <div class="mt-3">
          <button class="btn btn-primary" (click)="generateStoryboard()">
            <i class="fas fa-magic me-1"></i> توليد مع هذه التعليمات
          </button>
          <button class="btn btn-outline-secondary ms-2" (click)="togglePromptEditor()">
            <i class="fas fa-times me-1"></i> إغلاق
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  <div class="frame-container" style="padding:40px;">
    <div class="frames-scroll-container">
      @if (frames && frames.length > 0) {
      @for (frame of frames; track frame.id + '_' + $index) {
      <story-board-frame 
        [frameData]="frame" 
        [frameNumber]="$index + 1"
        [blockContent]="lessonBlock?.block?.block_content" 
        (contentUpdated)="onFrameContentUpdated($event)"
        (fileUploaded)="onFileUploaded($event)"
        (frameDeleted)="onFrameDeleted($event)" 
        (frameMoved)="onFrameMoved($event)" 
        class="frame-item" />
      }
      } @else {
      <div class="no-frames-placeholder">
        <i class="fas fa-plus-circle"></i>
        <p>أضف إطارات جديدة للقصة</p>
        <button class="btn btn-primary" (click)="addNewFrame()">
          <i class="fas fa-plus me-1"></i> إضافة إطار
        </button>
      </div>
      }
    </div>
  </div>
</main>