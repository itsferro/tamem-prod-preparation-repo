<div class="mcq-challenge-container" dir="rtl">
  <!-- Intro component for challenge start -->
  @if (currentState === 'intro') {
    <challenge-intro
      [currentStep]="currentStep"
      [questionData]="questionData"
      [isLoading]="isLoading"
      (startChallenge)="startChallenge($event)"
      (exitChallenge)="onExitChallenge()">
    </challenge-intro>
  }

  <!-- Questions section - only shown during challenge -->
  @if (currentState === 'questions' && questionData?.questions) {
    <div class="question-container">
      <div class="question-header">
        <div class="header-row">
          <!-- Mode indicator -->
          <div class="mode-indicator {{ mode === 'practice' ? 'practice-mode' : 'test-mode' }}">
            <div class="mode-icon small">
              @if (mode === 'practice') {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              } @else {
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                <polyline points="14 2 14 8 20 8"></polyline>
                <line x1="16" y1="13" x2="8" y2="13"></line>
                <line x1="16" y1="17" x2="8" y2="17"></line>
                <polyline points="10 9 9 9 8 9"></polyline>
              </svg>
              }
            </div>
            <span>{{ mode === 'practice' ? 'Ÿàÿ∂ÿπ ÿßŸÑÿ™ÿØÿ±Ÿäÿ®' : 'Ÿàÿ∂ÿπ ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±' }}</span>
          </div>

          <!-- Exit button -->
          <button class="exit-button" (click)="confirmExit()">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"></path>
            </svg>
            <span class="exit-text">ÿ•ŸÜŸáÿßÿ°</span>
          </button>
        </div>

        <!-- Second row with progress info and timer -->
        <div class="header-row progress-row">
          <div class="question-progress">
            <div class="progress-text">
              <span>ÿßŸÑÿ≥ÿ§ÿßŸÑ {{ currentQuestionIndex + 1 }} ŸÖŸÜ {{ questionData.questions.length }}</span>
              @if (mode === 'test') {
              <span class="timer-display">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                  stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                {{ remainingTime }} ÿ´
              </span>
              }
            </div>
            <div class="progress-bar">
              <div class="progress-fill"
                [style.width.%]="((currentQuestionIndex + 1) / questionData.questions.length) * 100"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="mcq-questions">
        <!-- Current question -->
        @if (questionData.questions[currentQuestionIndex]) {
        <div class="question-container">
          <div class="question-number">{{ currentQuestionIndex + 1 }}</div>
          <h3 class="question-text">{{ questionData.questions[currentQuestionIndex].text }}</h3>

          <!-- Options -->
          <div class="options-container">
            @for (option of questionData.questions[currentQuestionIndex].options; track option.id) {
            <div class="option"
              [class.selected]="userAnswers[questionData.questions[currentQuestionIndex].id] === option.id"
              [class.correct]="showAnswers && option.id === decodeBase64(questionData.questions[currentQuestionIndex].validationHash)"
              [class.incorrect]="showAnswers && userAnswers[questionData.questions[currentQuestionIndex].id] === option.id && option.id !== decodeBase64(questionData.questions[currentQuestionIndex].validationHash)"
              (click)="answerQuestion(questionData.questions[currentQuestionIndex].id, option.id)">
              <div class="option-marker">{{ option.id }}</div>
              <div class="option-text">{{ option.text }}</div>

              @if (showAnswers && option.id === decodeBase64(questionData.questions[currentQuestionIndex].validationHash)) {
              <div class="answer-indicator correct-answer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                  <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
              </div>
              } @else if (showAnswers && userAnswers[questionData.questions[currentQuestionIndex].id] === option.id &&
              option.id !== decodeBase64(questionData.questions[currentQuestionIndex].validationHash)) {
              <div class="answer-indicator wrong-answer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="15" y1="9" x2="9" y2="15"></line>
                  <line x1="9" y1="9" x2="15" y2="15"></line>
                </svg>
              </div>
              }
            </div>
            }
          </div>

          <!-- Explanation (for practice mode) -->
          @if (mode === 'practice' && showAnswers) {
          <div class="explanation"
            [class.correct-explanation]="userAnswers[questionData.questions[currentQuestionIndex].id] === decodeBase64(questionData.questions[currentQuestionIndex].validationHash)">
            <div class="explanation-header">
              @if (userAnswers[questionData.questions[currentQuestionIndex].id] ===
              decodeBase64(questionData.questions[currentQuestionIndex].validationHash)) {
              <span class="correct-icon">‚úì</span> ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©
              } @else {
              <span class="incorrect-icon">‚úó</span> ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©
              }
            </div>
            <p>{{ questionData.questions[currentQuestionIndex].explanation }}</p>
          </div>
          }
        </div>
        }

        <!-- Navigation buttons -->
        <div class="question-navigation">
          @if (showAnswers && mode === 'practice') {
          <button class="continue-button" (click)="moveToNextQuestion()">
            @if (currentQuestionIndex < questionData.questions.length - 1) { ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä <svg
              xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
              </svg>
              } @else {
              ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿ™ŸÖÿ±ŸäŸÜ
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              }
          </button>
          }
        </div>

        <!-- Feedback Panel Overlay -->
        @if (showFeedback) {
          <div class="feedback-overlay" 
               [class.correct-feedback]="feedbackType === 'correct'" 
               [class.incorrect-feedback]="feedbackType === 'incorrect'"
               [class.timeout-feedback]="feedbackType === 'timeout'">
            <div class="feedback-panel">
              <div class="feedback-header">
                <!-- Decorative icons to make it more joyful -->
                @if (feedbackType === 'correct') {
                  <div class="decoration-icons">
                    <span class="decoration-icon">‚úì</span>
                    <span class="decoration-icon">üéØ</span>
                    <span class="decoration-icon">‚úì</span>
                  </div>
                } @else if (feedbackType === 'incorrect') {
                  <div class="decoration-icons">
                    <span class="decoration-icon">√ó</span>
                    <span class="decoration-icon">‚ö†Ô∏è</span>
                    <span class="decoration-icon">√ó</span>
                  </div>
                } @else if (feedbackType === 'timeout') {
                  <div class="decoration-icons">
                    <span class="decoration-icon">‚è∞</span>
                    <span class="decoration-icon">‚åõ</span>
                    <span class="decoration-icon">‚è∞</span>
                  </div>
                }
              </div>
              
              <div class="feedback-icon">
                @if (feedbackType === 'correct') {
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/>
                  </svg>
                } @else if (feedbackType === 'incorrect') {
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="currentColor"/>
                  </svg>
                } @else if (feedbackType === 'timeout') {
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="48" height="48">
                    <circle cx="12" cy="12" r="10" fill="currentColor" fill-opacity="0.2" stroke="currentColor" stroke-width="2"/>
                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                }
              </div>
              
              <div class="feedback-message">
                @if (feedbackType === 'correct') {
                  ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©!
                } @else if (feedbackType === 'incorrect') {
                  ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©!
                } @else if (feedbackType === 'timeout') {
                  ÿßŸÜÿ™ŸáŸâ ÿßŸÑŸàŸÇÿ™!
                }
              </div>
              
              <!-- Score Stats Display - for all feedback types in test mode -->
              @if (mode === 'test') {
                <div class="score-stats">
                  <div class="score-stat correct-stat">
                    <span class="score-label">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©:</span>
                    <span class="score-value">{{ totalCorrectAnswers }}</span>
                  </div>
                  <div class="score-stat wrong-stat">
                    <span class="score-label">ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑÿÆÿßÿ∑ÿ¶ÿ©:</span>
                    <span class="score-value">{{ totalWrongAnswers }}</span>
                  </div>
                  @if (totalTimeouts > 0) {
                    <div class="score-stat timeout-stat">
                      <span class="score-label">ŸÖÿ±ÿßÿ™ ÿßŸÜÿ™Ÿáÿßÿ° ÿßŸÑŸàŸÇÿ™:</span>
                      <span class="score-value">{{ totalTimeouts }}</span>
                    </div>
                  }
                </div>
              }
              
              @if (feedbackType !== 'correct') {
                <div class="feedback-info">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M23 12c0 6.075-4.925 11-11 11S1 18.075 1 12 5.925 1 12 1s11 4.925 11 11z"/>
                    <path d="M12 8v4l2 2"/>
                  </svg>
                  ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ±ÿ¨ÿßÿπŸÉ ÿÆÿ∑Ÿàÿ™ŸäŸÜ ŸÑŸÑÿÆŸÑŸÅ
                </div>
              }
              
              <!-- Progress bar to show time remaining before panel disappears -->
              <div class="feedback-progress-container">
                <div class="feedback-progress" 
                     [style.animation-duration.ms]="feedbackType === 'correct' ? 750 : 1000"></div>
              </div>
            </div>
          </div>
        }
        
        <!-- Exit Confirmation Dialog -->
        @if (showExitConfirmation) {
          <div class="exit-confirmation-overlay">
            <div class="exit-confirmation-dialog">
              <div class="exit-confirmation-title">ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±ÿü</div>
              <div class="exit-confirmation-message">
                ÿ≥Ÿäÿ™ŸÖ ŸÅŸÇÿØÿßŸÜ ÿ™ŸÇÿØŸÖŸÉ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ± ŸàŸÑŸÜ Ÿäÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ•ÿ¨ÿßÿ®ÿßÿ™ŸÉ.
                ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ±ÿ∫ÿ®ÿ™ŸÉ ŸÅŸä ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©ÿü
              </div>
              <div class="exit-confirmation-buttons">
                <button class="exit-confirmation-cancel" (click)="cancelExit()">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button class="exit-confirmation-confirm" (click)="confirmExitChallenge()">ŸÜÿπŸÖÿå ÿ•ŸÜŸáÿßÿ° ÿßŸÑÿßÿÆÿ™ÿ®ÿßÿ±</button>
              </div>
            </div>
          </div>
        }
      </div>
    </div>
  }

  <!-- Result component for completion -->
  @if (currentState === 'complete') {
    <challenge-result
    [currentStep]="currentStep"
    [score]="score"
    [totalCorrect]="totalCorrect"
    [totalQuestions]="questionData?.questions?.length || 0"
    [mode]="mode"
    [passingScore]="currentStep?.passingThreshold || 70"
    (retryChallenge)="onRetryChallenge()"
    (finishChallenge)="onFinishChallenge()" 
    (exitChallenge)="onExitChallenge()">
  </challenge-result>
  }
</div>